<!-- The second page -> Displays a dynamic table of input cells for each player-gift combination -->

{% extends "layout.html" %}
{% block body_class %}valuations{% endblock %}
{% block content %}
<div class="top-actions">
  <div class="left">
    <button type="button" class="back-btn" onclick="history.back()">
      â†© Back
    </button>
  </div>
</div>

<div class="container mx-auto text-center no-spinners" style="max-width:900px;">

  <!-- Constraint explanation -->
  <div id="algorithmExplanationMessage" class="explanation-text text-start mb-4">
    Pay attention: For each gift, a playerâ€™s valuation is either the giftâ€™s fixed value (if they want it) or 0 (if they donâ€™t) â€” no other values are allowed.
  </div>
  <!-- Error message when constraint violated -->
  <div
    id="constraintErrorMessage"
    class="text-danger mb-3"
    style="display: none;"
  >
    Each gift must have the same non-zero value for all players, or zero if not chosen.
  </div>

  <!-- Example button -->
  <div class="w-100 d-flex justify-content-center mb-4">
    <button type="button" id="exampleBtn" class="back-btn">
      Generate Random Values ðŸŽ²
    </button>
  </div>

  <form method="POST" action="{{ url_for('run_algorithm') }}">
    <input type="hidden" name="num_players" value="{{ num_players }}">
    <input type="hidden" name="num_items" value="{{ num_items }}">

    <div class="valuations-desktop">
      <div class="valuations-table-wrap mb-4">
        <table class="table table-bordered text-center align-middle mx-auto">
          <thead class="table-light">
            <tr>
              <th></th>
              {% for j in range(1, num_items+1) %}
                <th class="fs-5">Gift {{ j }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for i in range(1, num_players+1) %}
              <tr>
                <th class="fs-6 align-middle">Player {{ i }}</th>
                {% for j in range(1, num_items+1) %}
                  <td>
                    <input
                      name="v-{{ i }}-{{ j }}"
                      type="number"
                      step="1"
                      min="0"
                      max="99"
                      class="form-control form-control-lg valuation-input"
                      required
                      placeholder="Value"
                      value="{{ previous_vals['Player_'~i]['c'~j] if previous_vals else 0 }}"
                    >

                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="w-100 d-flex justify-content-center">
      <button id="submitBtn" type="submit" class="gift-btn action-btn" disabled>
        <span>Run Santa Algorithm</span>
        <img src="{{ url_for('static', filename='images/animal.png') }}" alt="animal">
      </button>
    </div>

  </form>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const errorDiv = document.getElementById('constraintErrorMessage');
      const numPlayers = {{ num_players }};
      const numItems = {{ num_items }};
      const submitBtn = document.getElementById('submitBtn');
      const exampleBtn = document.getElementById('exampleBtn');
      const message = document.getElementById('algorithmExplanationMessage');

      // Fill example values
      exampleBtn.addEventListener('click', () => {
        for (let j = 1; j <= numItems; j++) { // the presents
          // random value between 1-10 != 0
          const valueForGift = Math.floor(Math.random() * 10) + 1;

          const selectedPlayers = []; // the players
          for (let i = 1; i <= numPlayers; i++) {
            if (Math.random() < 0.7) {
              selectedPlayers.push(i); // 70% probability to be chosen
            }
          }

          // if no one is in selectedPlayers -> choose randomly one
          if (selectedPlayers.length === 0) {
            selectedPlayers.push(Math.floor(Math.random() * numPlayers) + 1);
          }

          // fill the 0 values
          for (let i = 1; i <= numPlayers; i++) {
            const input = document.querySelector(`input.valuation-input[name="v-${i}-${j}"]`);
            input.value = selectedPlayers.includes(i) ? valueForGift : 0;
          }
        }

        validate(); // Integrity check
      });


      // Validation logic
      function validate() {
        let valid = true;
        for (let j = 1; j <= numItems; j++) { // the presents
          const inputs = Array.from(document.querySelectorAll(`input.valuation-input[name^="v-"][name$="-${j}"]`));
          const values = inputs.map(i => parseFloat(i.value) || 0); // from string to float
          const nonZero = values.filter(v => v !== 0); // only the non-zero values
          if (nonZero.length > 0) {
            const first = nonZero[0]; // the first value which need to be the gifts value
            if (!nonZero.every(v => v === first)) { // if there is a different value
              valid = false;
              inputs.forEach(i => i.classList.add('is-invalid')); // adding an error
            } else {
              inputs.forEach(i => i.classList.remove('is-invalid')); // removing the error if it is still exist
            }
          } else {
            inputs.forEach(i => i.classList.remove('is-invalid')); // removing the error if it is still exist
          }
        }
        if (valid) {
          submitBtn.disabled = false; // Allows to click the Run Algorithm button
          message.style.opacity = '1';
          errorDiv.style.display = 'none';
        } else { // Disabling the "next" button
          submitBtn.disabled = true;
          errorDiv.style.display = 'block';
        }
      }

      document.querySelectorAll('input.valuation-input').forEach(input => {
        input.addEventListener('input', validate);
      });


      // Initial check
      validate();
    });
  </script>
</div>
{% endblock %}
